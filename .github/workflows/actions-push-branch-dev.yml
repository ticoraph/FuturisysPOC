# Workflow d√©clench√© lors d'un push sur la branche dev
name: Actions Push Branch DEV

on:
  push:
    branches:
      - dev

jobs:
  # Job pour cr√©er automatiquement un tag
  create-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Permission n√©cessaire pour cr√©er des releases
    steps:
      - uses: actions/checkout@v4  # Version mise √† jour

      - name: Create Tag
        run: |
          # Configuration de l'identit√© Git pour les commits
          git config --local user.email "tico@outlook.fr"
          git config --local user.name "tico"
          # Cr√©ation d'un tag annot√© bas√© sur le num√©ro d'ex√©cution du workflow
          git tag -a "v${{ github.run_number }}" -m "Release v${{ github.run_number }}"
          # Push du tag vers le d√©p√¥t distant
          git push origin "v${{ github.run_number }}"

  # Job pour v√©rifier la qualit√© du code Python avec Ruff
  linting-code:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      # Installation de Python (derni√®re version 3.x)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install the code linting and formatting tool Ruff
      # Installation de Ruff via pipx pour l'analyse du code
      run: pipx install ruff

    - name: Lint code with Ruff
      # V√©rification des erreurs de code (linting) avec format de sortie GitHub
      run: ruff check --output-format=github --target-version=py39

    - name: Check code formatting with Ruff
      # V√©rification du formatage du code (affiche les diff√©rences sans modifier)
      run: ruff format --diff --target-version=py39
      # Continue m√™me en cas d'√©chec pour ne pas bloquer le workflow
      continue-on-error: true

  # Job pour ex√©cuter les tests unitaires avec pytest
  tests-api:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      # Installation de Python (derni√®re version 3.x)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Create .env file
      run: |
        echo "postgres_user=${{ vars.POSTGRES_USER }}" >> .env
        echo "postgres_user=${{ vars.POSTGRES_USER }}"
        echo "postgres_user_password=${{ secrets.POSTGRES_USER_PASSWORD }}" >> .env
        echo "supabase_host=${{ vars.SUPABASE_HOST }}" >> .env
        echo "supabase_host=${{ vars.SUPABASE_HOST }}"
        echo "postgres_port=${{ vars.POSTGRES_PORT }}" >> .env
        echo "postgres_port=${{ vars.POSTGRES_PORT }}"
        echo "postgres_db_name=${{ vars.POSTGRES_DB_NAME }}" >> .env
        echo "postgres_db_name=${{ vars.POSTGRES_DB_NAME }}"
        echo "model_path=${{ vars.MODEL_PATH }}" >> .env
        echo "model_path=${{ vars.MODEL_PATH }}"

    - name: Install dependencies
      run: |
        # Mise √† jour de pip
        python -m pip install --upgrade pip
        # Installation des d√©pendances du projet depuis requirements.txt
        pip install -r requirements.txt

    - name: Test with pytest
      run: |
        # Ex√©cution des tests avec g√©n√©ration de rapports de couverture (XML et HTML)
        pytest test/test_api.py --cov=src --cov-report=html

  # Job pour cr√©er une Pull Request vers la branche test
  create-pull-request:
    runs-on: ubuntu-latest
    # Attend que les jobs de linting et tests soient termin√©s avec succ√®s
    needs: [linting-code, tests-api]
    permissions:
      contents: write
      pull-requests: write  # Permission n√©cessaire pour cr√©er des PRs
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0  # R√©cup√®re tout l'historique pour pouvoir acc√©der aux branches

      - name: Checkout test branch
        run: |
          # R√©cup√®re la branche test depuis le d√©p√¥t distant
          git fetch origin test:test || echo "Branch test does not exist yet"
          # Bascule sur la branche test (la cr√©e si elle n'existe pas)
          git checkout test || git checkout -b test

      - name: Merge dev into test
        run: |
          # Configure Git pour les commits
          git config --local user.email "tico@outlook.fr"
          git config --local user.name "tico"
          # Merge de dev dans test
          git merge origin/dev --no-ff -m "Merge dev into test - Run #${{ github.run_number }}"
          # Push des changements vers test
          git push origin test

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: test
          base: main  # Branche cible de la PR (√† ajuster selon votre workflow)
          title: "üöÄ Merge test into main - v${{ github.run_number }}"
          body: |
            ## Changements propos√©s
            
            Cette PR contient les changements de la branche `dev` qui ont √©t√© merg√©s dans `test`.
            
            **Tag de version:** v${{ github.run_number }}
            
            ### V√©rifications effectu√©es
            - ‚úÖ Linting avec Ruff
            - ‚úÖ Tests unitaires avec pytest
            
            ### Commits inclus
            ${{ github.event.head_commit.message }}
            
            ---
            *PR cr√©√©e automatiquement par GitHub Actions*
          labels: |
            automated-pr
            test-to-main
          draft: false  # Mettre √† true si vous voulez cr√©er une PR en brouillon